AZURE_CLIENT_ID: "{{ azure_service_principal }}"
AZURE_TENANT: "{{ azure_tenant }}"
AZURE_SECRET: "{{ azure_password }}"
AZURE_SUBSCRIPTION_ID: "{{ azure_subscription_id }}"
AZURE_CONFIG_DIR: "{{  output_dir  }}/.azure-${AZ_PROJECT_TAG}"

export AZ_RESOURCE_GROUP=aro-${GUID}
export AZ_PROJECT_TAG=aro-${GUID}

# Console
# az_aro4_public_hostname
    export AZ_ARO4_CONSOLE=$(az aro list -o json | jq -r "[.[]|select(.name==\"aro-cluster-${GUID}\")][0].consoleProfile.url")
    echo ${AZ_ARO4_CONSOLE}
AD Variable: %aro_console%

export 


# az_aro4_public_api
    export AZ_ARO4_PUBLIC_API=$(az aro list -o json | jq -r "[.[]|select(.name==\"aro-cluster-${GUID}\")][0].apiserverProfile.url")
    echo ${AZ_ARO4_PUBLIC_API}

AD Variable: %aro_api%

export 


az_aro4_domain=
  export AZ_ARO4_DOMAIN=$(az aro list -o json | jq -r "[.[]|select(.name==\"aro-cluster-${GUID}\")][0].domain")
  echo ${AZ_ARO4_DOMAIN}
  az aro show --resource-group ${AZ_RESOURCE_GROUP} --name ${AZ_PROJECT_TAG} --query clusterProfile.domain -o tsv

export 


az_aro4_location = 
  export AZ_ARO4_LOCATION=$(az aro list -o json | jq -r "[.[]|select(.name==\"aro-cluster-${GUID}\")][0].location")
  echo ${AZ_ARO4_LOCATION}

    az aro show --resource-group ${AZ_RESOURCE_GROUP} --name ${AZ_PROJECT_TAG} --query location -o tsv

Set Reply URL
    az ad app update --id {{ az_appreg_objectid.stdout }} --reply-urls
    {{ 'https://oauth-openshift.apps.{0}.{1}.aroapp.io/oauth2callback/RHPDS-AAD'.format(
    az_aro4_domain.stdout,
    az_aro4_location.stdout
    ) }}

Kubeadmin Password: %aro_kube_password%

Create Secret:
         oc create secret generic '{{ aroidkey.stdout }}-secret-azuread'
          --namespace openshift-config
          --from-literal=clientSecret='{{ az_appreg_secret.stdout }}'


az_kv_name: RHPDSAppRegList
az_kv_id: id-
az_kv_key: key-


az_function_get: "https://{{az_function_hostname}}/api/get/"
az_function_release: "https://{{az_function_hostname}}/api/release/"

aroidkey = 
    curl {{ az_function_get }}${AZ_PROJECT_TAG}
    curl https://rhpdspoolhandler.azurewebsites.net/api/get/aro-${GUID}

Get Appreg App ID:
az_appreg_objectid = 
    az keyvault secret show
          --vault-name RHPDSAppRegList
          --name 'id-{{ aroidkey.stdout }}'
          --query value -o tsv

    - name: Retrieving Secret
      command: >
Get App Secret:
az_appreg_secret = 
    az keyvault secret show
          --vault-name RHPDSAppRegList
          --name 'key-{{ aroidkey.stdout }}'
          --query value -o tsv

project_tag: "{{ env_type }}-{{ guid }}"
az_resource_group: ${AZ_PROJECT_TAG}

OAuth:

---
apiVersion: config.openshift.io/v1
kind: OAuth
metadata:
  name: cluster
spec:
  identityProviders:
  - name: RHPDS-AAD
    mappingMethod: claim
    type: OpenID
    openID:
      clientID: {{az_appreg_objectid.stdout}}
      clientSecret:
        name: '{{aroidkey.stdout}}-secret-azuread'
      extraScopes:
      - email
      - profile
      extraAuthorizeParameters:
        include_granted_scopes: "true"
      claims:
        preferredUsername:
        - email
        - upn
        name:
        - name
        email:
        - email
      issuer: https://login.microsoftonline.com/{{azure_tenant}}

then `oc logout`
